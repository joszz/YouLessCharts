var loadingEnabled=false,tmpWatt=0
function requestLiveData(){$.ajax({url:'ajax.php?a=live',dataType:'json',success:function(json){var interval=$('#settingsOverlay').data('liveinterval'),shiftMax=6e4/interval,series=chart.series[0],shift=series.data.length>shiftMax,x=(new Date()).getTime(),y=json.pwr;chart.series[0].addPoint([x,y],true,shift);if(tmpWatt<parseInt(json.pwr)){updown="countUp"}else if(tmpWatt==parseInt(json.pwr)){updown=""}else updown="countDown";tmpWatt=parseInt(json.pwr);$('#wattCounter').html("<span class='"+updown+"'>"+json.pwr+" Watt</span>");setTimeout(requestLiveData,interval)},cache:false})}
function calculate(target,date){$('#kwhCounter').html("<span style='line-height:30px;font-style:italic;'>Loading…</span>");$('#cpkwhCounter').html("<span style='line-height:30px;font-style:italic;'>Loading…</span>");$.ajax({url:'ajax.php?a=calculate_'+target+'&date='+date,dataType:'json',success:function(jsonData){if($('input[name=dualcount]:checked').val()==1){$('#kwhCounter').html("<span>H: "+jsonData.kwh+" kWh<br>L: "+jsonData.kwhLow+" kWh</span>");$('#cpkwhCounter').html("<span>H: € "+jsonData.price+" <br>L: € "+jsonData.priceLow+"</span>")}else{$('#kwhCounter').html("<span style='line-height:30px;'>"+jsonData.kwh+" kWh</span>");$('#cpkwhCounter').html("<span style='line-height:30px;'>€ "+jsonData.price+"</span>")}},cache:false})}
function createChart(target,date){if(loadingEnabled){historychart.showLoading()}else loadingEnabled=true;$.ajax({url:'ajax.php?a='+target+'&date='+date,dataType:'json',success:function(jsonData){if(jsonData.ok==0){$('#message').text(jsonData.msg);$('#overlay').fadeIn()};jsDate=jsonData.start.split("-");year=jsDate[0];month=jsDate[1]-1;day=jsDate[2]-0;var start=(new Date(year,month,day)).getTime();if(target=='week'){var title='Weekverbruik',type='areaspline',serieName='Watt',yTitle={text:'Watt',margin:40},rangeSelector=true,navScroll=true,pointInterval=60*1e3,tickInterval=null,plotLines=[{value:start+(24*60*60*1e3),width:1,color:'#c0c0c0'},{value:start+(2*24*60*60*1e3),width:1,color:'#c0c0c0'},{value:start+(3*24*60*60*1e3),width:1,color:'#c0c0c0'},{value:start+(4*24*60*60*1e3),width:1,color:'#c0c0c0'},{value:start+(5*24*60*60*1e3),width:1,color:'#c0c0c0'},{value:start+(6*24*60*60*1e3),width:1,color:'#c0c0c0'}],buttons=[{type:'hour',count:1,text:'1u'},{type:'hour',count:12,text:'12u'},{type:'day',count:1,text:'dag'},{type:'week',count:1,text:'week'}]}else if(target=='day'){var title='Dagverbruik',type='areaspline',serieName='Watt',yTitle={text:'Watt',margin:40},rangeSelector=false,navScroll=true,pointInterval=60*1e3,tickInterval=null,plotLines=null,buttons=[{type:'hour',count:1,text:'1u'},{type:'hour',count:12,text:'12u'},{type:'day',count:1,text:'dag'}]}else if(target=='month'){var title='Maandverbruik',type='column',serieName='kWh',yTitle={text:'Kilowattuur',margin:40},rangeSelector=false,navScroll=false,pointInterval=24*60*60*1e3,tickInterval=48*60*60*1e3,plotLines=null,buttons=[]};data=jsonData.val.split(",");for(var i=0;i<data.length;i++)data[i]=parseFloat(data[i],10);historychart=new Highcharts.StockChart({chart:{renderTo:'history',type:type},rangeSelector:{buttons:buttons},credits:{enabled:false},title:{text:title},yAxis:{showFirstLabel:false,title:yTitle},xAxis:{type:'datetime',tickInterval:tickInterval,plotLines:plotLines},rangeSelector:{enabled:rangeSelector},navigator:{enabled:navScroll},scrollbar:{enabled:navScroll},series:[{name:serieName,turboThreshold:5e3,data:data,pointStart:start,pointInterval:pointInterval,tooltip:{valueDecimals:2}}]});calculate(target,date)},cache:false})};$(document).ready(function(){$('#closeDialog').click(function(){$('#overlay').hide()});$('#showSettings').click(function(){$('#settingsOverlay').slideDown()});$('#hideSettings').click(function(){$('#settingsOverlay').slideUp(function(){var dualcnt=$('input[name=dualcount]:checked').val();if(dualcnt!=$('#settingsOverlay').data('dualcount')){$('input[name=dualcount]').not(':checked').attr('checked',true);if($('#settingsOverlay').data('dualcount')==1){$('.cpkwhlow').show()}else $('.cpkwhlow').hide()}})});$('input[name=dualcount]').change(function(){var dualcnt=$('input[name=dualcount]:checked').val();if(dualcnt==1){$('.cpkwhlow').show()}else $('.cpkwhlow').hide()});$('#saveSettings').click(function(){$.ajax({url:'ajax.php?a=saveSettings',type:'POST',dataType:'json',data:$('#settingsOverlay form').serialize(),success:function(data){$('#settingsOverlay').slideUp('fast',function(){$('#settingsOverlay input[type=password]').val('')});if($('#settingsOverlay').data('dualcount')!=$('input[name=dualcount]:checked').val()){$('#settingsOverlay').data('dualcount',$('input[name=dualcount]:checked').val());var chart=$('#history').data('chart');calculate(chart,$('#datepicker').val())};$('#settingsOverlay').data('liveinterval',$('select[name=liveinterval]').val());$('#message').text(data.msg);$('#overlay').fadeIn()}});return false});$('.showChart').click(function(){var chart=$(this).data('chart');$('.chart').hide();$('.'+chart).show();$('.btn li').each(function(){$(this).removeClass('selected')});$(this).parent().addClass('selected');$('#history').data('chart',chart);if(chart!='live')createChart(chart,$('#datepicker').val())});Highcharts.setOptions({global:{useUTC:false},lang:{decimalPoint:',',months:['Januari','Februari','Maart','April','Mei','Juni','Juli','Augustus','September','Oktober','November','December'],shortMonths:['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'],weekdays:['Zondag','Maandag','Dinsdag','Woensdag','Donderdag','Vrijdag','Zaterdag']}});chart=new Highcharts.Chart({chart:{renderTo:'live',defaultSeriesType:'areaspline',events:{load:requestLiveData}},credits:{enabled:false},legend:{enabled:false},title:{text:'Actueel verbruik'},xAxis:{type:'datetime',tickPixelInterval:150,minRange:60*1e3},yAxis:{showFirstLabel:false,minPadding:0.2,maxPadding:0.2,title:{text:'Watt',margin:40}},series:[{name:'Watt',data:[]}],exporting:{enabled:false}});$('#datepicker').datepicker({inline:true,dateFormat:'yy-mm-dd',maxDate:new Date(),showOn:'focus',firstDay:1,monthNames:['Januari','Februari','Maart','April','Mei','Juni','Juli','Augustus','September','Oktober','November','December'],monthNamesShort:['jan','feb','maa','apr','mei','jun','jul','aug','sep','okt','nov','dec'],dayNames:['zondag','maandag','dinsdag','woensdag','donderdag','vrijdag','zaterdag'],dayNamesShort:['zon','maa','din','woe','don','vri','zat'],dayNamesMin:['zo','ma','di','wo','do','vr','za'],onSelect:function(date,inst){var target=$('#history').data('chart');createChart(target,date)}})})